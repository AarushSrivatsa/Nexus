<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nexus</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Space+Grotesk:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#05080d;--s1:#080e16;--s2:#0c1520;--s3:#111e2e;
  --b1:#162030;--b2:#1e2e42;
  --t1:#eef4ff;--t2:#7a9bbf;--t3:#3a5470;
  --a:#00e5ff;--a2:#0066ff;
  --ag:linear-gradient(135deg,#00e5ff,#0066ff);
  --adim:#00e5ff12;--danger:#ff3d6b;
  --ease:cubic-bezier(.16,1,.3,1);--ease2:cubic-bezier(.4,0,.2,1);
  --sb:272px;
}
html,body{height:100%;}
body{
  font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);
  display:flex;overflow:hidden;font-size:14px;-webkit-font-smoothing:antialiased;
}
body::before{
  content:'';position:fixed;top:-300px;right:-300px;width:700px;height:700px;
  background:radial-gradient(circle,#00e5ff07 0%,transparent 65%);
  pointer-events:none;z-index:0;
}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--b2);border-radius:3px;}

/* AUTH */
#auth-overlay{
  position:fixed;inset:0;background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  z-index:200;transition:opacity .5s var(--ease),visibility .5s;
  overflow-y:auto;
}
#auth-overlay.hidden{opacity:0;visibility:hidden;pointer-events:none;}
.auth-wrap{width:100%;max-width:400px;padding:0 28px;margin:auto;}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:44px;}
.auth-logo-mark{
  width:42px;height:42px;border-radius:13px;background:var(--ag);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 32px #00e5ff3a, 0 0 0 1px #00e5ff22;flex-shrink:0;
}
.auth-logo-name{
  font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700;
  letter-spacing:.18em;color:var(--t1);
  background:var(--ag);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.auth-byline{font-size:10px;color:var(--t3);font-family:'Space Grotesk',sans-serif;font-weight:500;letter-spacing:.04em;margin-top:2px;}
.auth-byline-link{color:var(--t3);text-decoration:none;transition:color .2s;}
.auth-byline-link:hover{color:var(--a);}
.auth-h{font-family:'Space Grotesk',sans-serif;font-size:25px;font-weight:600;letter-spacing:-.02em;margin-bottom:6px;line-height:1.2;}
.auth-sub{font-size:13px;color:var(--t3);margin-bottom:32px;}
.seg{display:flex;background:var(--s1);border:1px solid var(--b1);border-radius:13px;padding:4px;margin-bottom:26px;gap:3px;}
.seg-btn{
  flex:1;padding:9px;border:none;background:none;border-radius:9px;
  font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:600;
  color:var(--t3);cursor:pointer;transition:all .2s var(--ease2);letter-spacing:.04em;
}
.seg-btn.on{background:var(--s3);color:var(--t1);box-shadow:0 1px 8px rgba(0,0,0,.3);}
.fg{margin-bottom:13px;}
.fg label{
  display:block;font-family:'Space Grotesk',sans-serif;
  font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  color:var(--t3);margin-bottom:7px;
}
.fg input{
  width:100%;padding:12px 16px;background:var(--s1);border:1px solid var(--b1);border-radius:12px;
  font-family:'DM Sans',sans-serif;font-size:13px;color:var(--t1);
  outline:none;transition:border-color .2s,box-shadow .2s;
}
.fg input:focus{border-color:var(--a)77;box-shadow:0 0 0 3px var(--adim);}
.fg input::placeholder{color:var(--t3);}
.pw-wrap{position:relative;display:block;}
.pw-wrap input{width:100%;padding-right:44px;}
.pw-eye{
  position:absolute;right:13px;top:50%;transform:translateY(-50%);
  background:none;border:none;cursor:pointer;color:var(--t3);
  display:flex;align-items:center;justify-content:center;
  transition:color .2s;padding:0;z-index:2;width:20px;height:20px;
}
.pw-eye:hover{color:var(--t2);}
.otp-row{display:flex;gap:8px;}
.otp-row input{flex:1;text-align:center;font-family:'JetBrains Mono',monospace;font-size:22px;letter-spacing:.2em;}
.otp-resend{
  padding:12px 14px;background:var(--s2);border:1px solid var(--b1);border-radius:12px;
  font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;
  color:var(--t2);cursor:pointer;white-space:nowrap;transition:all .2s;
}
.otp-resend:hover:not(:disabled){border-color:var(--b2);color:var(--t1);}
.otp-resend:disabled{opacity:.35;cursor:not-allowed;}
.btn-main{
  width:100%;padding:13px;margin-top:8px;background:var(--ag);border:none;border-radius:12px;
  font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:700;
  color:#000;cursor:pointer;letter-spacing:.04em;
  transition:opacity .2s,transform .15s var(--ease),box-shadow .2s;
  box-shadow:0 4px 24px #00e5ff22;
}
.btn-main:hover{opacity:.87;box-shadow:0 6px 32px #00e5ff3a;}
.btn-main:active{transform:scale(.97);}
.auth-err{font-size:12px;color:var(--danger);margin-top:10px;min-height:16px;font-weight:500;}
.email-pill{
  margin-bottom:16px;padding:11px 16px;background:var(--s2);border:1px solid var(--b1);border-radius:12px;
  display:flex;align-items:center;justify-content:space-between;
}
.email-pill span{font-size:12px;color:var(--t2);font-weight:500;}
.email-pill button{font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:700;color:var(--a);background:none;border:none;cursor:pointer;}

/* MOBILE RESPONSIVE */
@media(max-width:680px){
  :root{--sb:82vw;}
  #sidebar{
    position:fixed;top:0;left:0;height:100%;z-index:50;
    transform:translateX(-100%);transition:transform .3s var(--ease);
    box-shadow:none;
  }
  #sidebar.open{transform:translateX(0);box-shadow:4px 0 40px rgba(0,0,0,.6);}
  #sb-overlay{display:block;}
  #sb-overlay.open{opacity:1;pointer-events:all;}
  #main{width:100%;}
  .topbar{padding:0 14px;}
  .topbar-title{font-size:12px;}
  #messages{padding:20px 4% 16px;}
  .msg-bubble{max-width:88%;font-size:13px;padding:10px 14px;}
  .input-area{padding:4px 10px 10px;}
  .modal-box{max-width:calc(100vw - 24px)!important;padding:22px 18px;border-radius:18px;margin:0 12px;}
  .auth-wrap{padding:0 20px;}
  .auth-logo{margin-bottom:32px;}
  .auth-h{font-size:22px;}
  #toast{bottom:18px;max-width:calc(100vw - 40px);white-space:normal;text-align:center;}
  .sb-del{display:flex!important;}
  .msg-bubble pre{font-size:11px;padding:10px 12px;}
  .otp-row{flex-direction:column;}
  .otp-resend{width:100%;justify-content:center;display:flex;}
}

/* SIDEBAR */
#sb-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:49;opacity:0;pointer-events:none;
  transition:opacity .3s var(--ease2);backdrop-filter:blur(4px);
}
.topbar-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
.topbar-right{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.topbar-icon-btn{
  width:34px;height:34px;border:1px solid var(--b1);border-radius:9px;
  background:none;cursor:pointer;color:var(--t3);
  display:none;align-items:center;justify-content:center;
  transition:all .2s var(--ease2);flex-shrink:0;
}
.topbar-icon-btn:hover{border-color:var(--b2);color:var(--t2);background:var(--s2);}
@media(max-width:680px){.topbar-icon-btn{display:flex;}}

#sidebar{
  width:var(--sb);background:var(--s1);border-right:1px solid var(--b1);
  display:flex;flex-direction:column;flex-shrink:0;position:relative;z-index:1;
}
.sb-top{padding:16px 16px 14px;border-bottom:1px solid var(--b1);display:flex;align-items:center;}
.sb-brand{display:flex;align-items:center;gap:10px;}
.sb-mark{
  width:28px;height:28px;border-radius:8px;background:var(--ag);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 14px #00e5ff28, 0 0 0 1px #00e5ff1a;flex-shrink:0;
}
.sb-name{
  font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:700;letter-spacing:.12em;
  background:var(--ag);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.sb-new-wrap{padding:10px 10px 4px;}
.sb-new-btn{
  width:100%;padding:10px 14px;background:var(--adim);border:1px solid var(--a)2a;
  border-radius:11px;cursor:pointer;font-family:'Space Grotesk',sans-serif;
  font-size:12px;font-weight:700;color:var(--a);letter-spacing:.04em;
  transition:all .2s var(--ease2);display:flex;align-items:center;justify-content:center;gap:7px;
}
.sb-new-btn:hover{background:var(--a)1c;border-color:var(--a)55;box-shadow:0 0 18px var(--a)14;}
.sb-list{flex:1;overflow-y:auto;padding:4px 8px;}
.sb-section{
  font-family:'Space Grotesk',sans-serif;font-size:9px;font-weight:700;
  letter-spacing:.14em;text-transform:uppercase;color:var(--t3);padding:10px 8px 5px;
}
.sb-item{
  padding:9px 10px;border-radius:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:space-between;
  transition:all .15s var(--ease2);gap:8px;border:1px solid transparent;margin-bottom:1px;
}
.sb-item:hover{background:var(--s2);}
.sb-item.active{background:var(--adim);border-color:var(--a)1e;}
.sb-item-title{font-size:12px;color:var(--t2);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;transition:color .15s;}
.sb-item.active .sb-item-title{color:var(--a);}
.sb-item:hover .sb-item-title{color:var(--t1);}
.sb-del{
  width:18px;height:18px;border:none;background:none;border-radius:4px;
  cursor:pointer;color:var(--t3);display:none;align-items:center;justify-content:center;
  flex-shrink:0;transition:color .15s;
}
.sb-item:hover .sb-del{display:flex;}
.sb-del:hover{color:var(--danger);}
.sb-brand-text{display:flex;flex-direction:column;gap:1px;}
.sb-byline{font-size:9px;color:var(--t3);font-family:'Space Grotesk',sans-serif;font-weight:500;letter-spacing:.04em;}
.sb-byline-link{color:var(--t3);text-decoration:none;transition:color .2s;}
.sb-byline-link:hover{color:var(--a);}
.sb-foot{padding:10px;border-top:1px solid var(--b1);display:flex;flex-direction:column;gap:6px;}
.sb-logout{
  width:100%;padding:11px;background:transparent;border:1px solid var(--danger)2e;
  border-radius:11px;cursor:pointer;font-family:'Space Grotesk',sans-serif;
  font-size:12px;font-weight:700;color:var(--danger);letter-spacing:.04em;
  transition:all .2s var(--ease2);display:flex;align-items:center;justify-content:center;gap:7px;
}
.sb-logout:hover{background:var(--danger)10;border-color:var(--danger)55;box-shadow:0 0 14px var(--danger)14;}

/* MAIN */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;z-index:1;}
.topbar{
  padding:0 24px;height:50px;border-bottom:1px solid var(--b1);
  background:var(--s1);display:flex;align-items:center;flex-shrink:0;
}
.topbar-title{font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:600;color:var(--t2);letter-spacing:.02em;}

/* MESSAGES */
#messages{flex:1;overflow-y:auto;padding:32px 11% 20px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth;}
.empty,.no-conv{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding-bottom:80px;}
.empty-glyph,.no-conv-glyph{
  width:52px;height:52px;border-radius:16px;
  background:linear-gradient(135deg,var(--a)16,var(--a2)0a);
  border:1px solid var(--a)1e;display:flex;align-items:center;justify-content:center;font-size:22px;
}
.empty-title,.no-conv-text{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:600;color:var(--t2);}
.empty-hint{font-size:12px;color:var(--t3);text-align:center;max-width:260px;line-height:1.7;}
.msg-row{display:flex;animation:rise .22s var(--ease);}
.msg-row.user{justify-content:flex-end;}
.msg-row.assistant{justify-content:flex-start;}
@keyframes rise{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.msg-bubble{max-width:72%;padding:12px 18px;font-size:13.5px;line-height:1.75;}
.msg-row.user .msg-bubble{
  background:var(--ag);color:#000;font-weight:500;
  border-radius:20px 20px 5px 20px;box-shadow:0 4px 18px #00e5ff18;
}
.msg-row.assistant .msg-bubble{
  background:var(--s2);color:var(--t1);
  border-radius:20px 20px 20px 5px;border:1px solid var(--b1);
}
.msg-row.user .msg-bubble strong{color:#000;}
.msg-row.user .msg-bubble a{color:#000;opacity:.75;}
.msg-bubble pre{
  font-family:'JetBrains Mono',monospace;font-size:12px;
  background:var(--bg);border:1px solid var(--b2);
  padding:14px 16px;border-radius:10px;overflow-x:auto;
  margin:10px 0 4px;white-space:pre-wrap;line-height:1.6;color:var(--a);
}
.msg-row.user .msg-bubble pre{background:rgba(0,0,0,.2);border-color:rgba(0,0,0,.15);color:#000;}
.msg-bubble .mh1{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;margin:18px 0 6px;color:var(--t1);line-height:1.3;}
.msg-bubble .mh2{font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:700;margin:14px 0 5px;color:var(--t1);line-height:1.3;}
.msg-bubble .mh3{font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:700;margin:12px 0 4px;color:var(--t1);line-height:1.3;}
.msg-bubble .mh1:first-child,.msg-bubble .mh2:first-child,.msg-bubble .mh3:first-child{margin-top:2px;}
.msg-bubble p{margin:0 0 10px;line-height:1.75;}
.msg-bubble p:last-child{margin-bottom:0;}
.msg-bubble ul,.msg-bubble ol{margin:6px 0 10px;padding-left:0;list-style:none;}
.msg-bubble ul:last-child,.msg-bubble ol:last-child{margin-bottom:0;}
.msg-bubble li{padding:3px 0 3px 20px;position:relative;line-height:1.65;}
.msg-bubble ul li::before{content:'‚Ä¢';position:absolute;left:6px;color:var(--a);font-size:14px;line-height:1.65;}
.msg-bubble ol{counter-reset:ol-counter;}
.msg-bubble ol li{counter-increment:ol-counter;}
.msg-bubble ol li::before{content:counter(ol-counter)'.';position:absolute;left:0;color:var(--a);font-size:12px;font-family:'JetBrains Mono',monospace;font-weight:600;line-height:1.9;}
.msg-bubble code{font-family:'JetBrains Mono',monospace;font-size:11.5px;background:var(--s3);padding:2px 6px;border-radius:5px;color:var(--a);border:1px solid var(--b2);}
.msg-row.user .msg-bubble code{background:rgba(0,0,0,.15);color:#000;border-color:rgba(0,0,0,.1);}
.msg-bubble hr{border:none;border-top:1px solid var(--b2);margin:12px 0;}
.msg-bubble blockquote{border-left:3px solid var(--a)55;padding-left:12px;margin:8px 0;color:var(--t2);font-style:italic;}
.msg-row.user .msg-bubble .mh1,.msg-row.user .msg-bubble .mh2,.msg-row.user .msg-bubble .mh3{color:#000;}
.msg-row.user .msg-bubble ul li::before,.msg-row.user .msg-bubble ol li::before{color:rgba(0,0,0,.5);}
.msg-row.user .msg-bubble blockquote{border-left-color:rgba(0,0,0,.2);color:rgba(0,0,0,.7);}
.msg-row.user .msg-bubble hr{border-top-color:rgba(0,0,0,.15);}
.typing{display:flex;gap:5px;align-items:center;padding:4px 2px;}
.tdot{width:5px;height:5px;border-radius:50%;background:var(--t3);animation:tdot 1.4s infinite;}
.tdot:nth-child(2){animation-delay:.18s;}
.tdot:nth-child(3){animation-delay:.36s;}
@keyframes tdot{0%,60%,100%{transform:translateY(0);opacity:.3;}30%{transform:translateY(-5px);opacity:1;}}

/* INPUT */
.input-area{padding:6px 11% 12px;flex-shrink:0;}
.input-wrap{
  display:flex;flex-direction:column;
  background:var(--s1);border:1px solid var(--b2);
  border-radius:14px;padding:6px 6px 6px 16px;
  transition:border-color .25s,box-shadow .25s;
}
.input-wrap:focus-within{border-color:var(--a)44;box-shadow:0 0 0 3px var(--adim);}
.input-row{display:flex;align-items:flex-end;gap:8px;}
#msg-input{
  flex:1;border:none;background:none;
  font-family:'DM Sans',sans-serif;font-size:16px;color:var(--t1);
  outline:none;resize:none;max-height:160px;line-height:1.6;padding:2px 0;
}
@media(min-width:681px){#msg-input{font-size:13.5px;}}
#msg-input::placeholder{color:var(--t3);}
.input-btns{display:flex;gap:4px;align-items:center;flex-shrink:0;padding-bottom:0;}
.ib{
  width:30px;height:30px;border:1px solid var(--b2);border-radius:8px;
  background:none;cursor:pointer;color:var(--t3);
  display:flex;align-items:center;justify-content:center;
  transition:all .2s var(--ease2);flex-shrink:0;
}
.ib:hover{border-color:var(--a)55;color:var(--a);background:var(--adim);}
.send-ib{
  width:30px;height:30px;background:var(--ag);border:none;border-radius:8px;
  cursor:pointer;color:#000;display:flex;align-items:center;justify-content:center;
  transition:opacity .2s,transform .15s var(--ease),box-shadow .2s;
  box-shadow:0 2px 14px #00e5ff2a;flex-shrink:0;
}
.send-ib:hover{opacity:.88;box-shadow:0 4px 22px #00e5ff44;}
.send-ib:active{transform:scale(.9);}
.send-ib:disabled{opacity:.18;cursor:not-allowed;box-shadow:none;}

/* MODEL BAR */
.model-bar{
  display:flex;align-items:center;gap:5px;
  padding:7px 0 2px;
  border-top:1px solid var(--b1);
  margin-top:5px;
  overflow-x:auto;
  scrollbar-width:none;
  -webkit-overflow-scrolling:touch;
}
.model-bar::-webkit-scrollbar{display:none;}
.model-bar-label{
  font-family:'Space Grotesk',sans-serif;font-size:9px;font-weight:700;
  letter-spacing:.12em;text-transform:uppercase;color:var(--t3);
  flex-shrink:0;margin-right:2px;
}
.model-chip{
  display:inline-flex;align-items:center;gap:5px;
  padding:4px 11px;border-radius:100px;
  border:1px solid var(--b1);background:none;
  font-family:'Space Grotesk',sans-serif;font-size:10px;font-weight:700;
  color:var(--t3);cursor:pointer;white-space:nowrap;letter-spacing:.04em;
  transition:all .18s var(--ease2);flex-shrink:0;
}
.model-chip:hover{border-color:var(--b2);color:var(--t2);background:var(--s2);}
.model-chip.active{
  border-color:var(--a)55;color:var(--a);
  background:var(--adim);
}
.model-chip-dot{
  width:5px;height:5px;border-radius:50%;
  background:var(--t3);transition:background .18s;flex-shrink:0;
}
.model-chip.active .model-chip-dot{background:var(--a);}

/* MODALS */
.modal-bg{
  position:fixed;inset:0;background:rgba(0,0,0,.78);
  display:flex;align-items:center;justify-content:center;
  z-index:100;opacity:0;pointer-events:none;
  transition:opacity .2s var(--ease2);backdrop-filter:blur(10px);
}
.modal-bg.open{opacity:1;pointer-events:all;}
.modal-box{
  background:var(--s1);border:1px solid var(--b2);border-radius:22px;
  padding:28px;width:100%;max-width:420px;
  transform:translateY(16px) scale(.96);
  transition:transform .28s var(--ease);
  box-shadow:0 28px 70px rgba(0,0,0,.6);
}
.modal-bg.open .modal-box{transform:translateY(0) scale(1);}
.modal-title{font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:12px;color:var(--t3);margin-bottom:22px;}
.up-tabs{display:flex;gap:3px;background:var(--s2);border:1px solid var(--b1);border-radius:12px;padding:3px;margin-bottom:16px;}
.up-tab{
  flex:1;padding:8px;border:none;background:none;border-radius:9px;
  font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:700;
  color:var(--t3);cursor:pointer;transition:all .2s var(--ease2);
}
.up-tab.on{background:var(--s3);color:var(--t1);}
.dropzone{
  border:1px dashed var(--b2);border-radius:14px;
  padding:30px 20px;text-align:center;cursor:pointer;
  transition:all .2s var(--ease2);margin-bottom:12px;
}
.dropzone:hover,.dropzone.drag{border-color:var(--a)77;background:var(--adim);}
.dropzone-icon{font-size:28px;margin-bottom:10px;}
.dropzone-text{font-size:12px;color:var(--t3);line-height:1.7;}
.dropzone-text strong{color:var(--t2);}
#file-input{display:none;}
#file-name{font-size:12px;color:var(--a);min-height:16px;font-weight:600;}
.modal-foot{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}
.btn-ghost{
  padding:10px 18px;background:none;border:1px solid var(--b2);border-radius:10px;
  font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:700;
  color:var(--t2);cursor:pointer;transition:all .2s;
}
.btn-ghost:hover{color:var(--t1);}
.btn-act{
  padding:10px 20px;background:var(--ag);border:none;border-radius:10px;
  font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:700;
  color:#000;cursor:pointer;transition:opacity .2s;box-shadow:0 2px 12px #00e5ff22;
}
.btn-act:hover{opacity:.87;}

/* TOAST */
#toast{
  position:fixed;bottom:28px;left:50%;
  transform:translateX(-50%) translateY(14px);
  background:var(--s3);border:1px solid var(--b2);
  color:var(--t1);padding:10px 22px;border-radius:100px;
  font-size:12px;font-weight:600;
  opacity:0;pointer-events:none;
  transition:all .28s var(--ease);z-index:300;white-space:nowrap;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

.file-pill{display:flex;justify-content:center;margin:8px 0;}
.file-pill-inner{
  background:var(--s2);border:1px solid var(--b1);border-radius:100px;
  padding:6px 16px;font-size:11px;color:var(--t3);
  display:flex;align-items:center;gap:7px;font-weight:600;
}
</style>
</head>
<body>

<div id="sb-overlay" onclick="closeSidebar()"></div>

<!-- AUTH -->
<div id="auth-overlay">
  <div class="auth-wrap">
    <div class="auth-logo">
      <div class="auth-logo-mark">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <line x1="5" y1="12" x2="19" y2="12" stroke="#000" stroke-width="1.5" stroke-opacity="0.35"/>
          <line x1="12" y1="5" x2="12" y2="19" stroke="#000" stroke-width="1.5" stroke-opacity="0.35"/>
          <line x1="5" y1="12" x2="12" y2="5" stroke="#000" stroke-width="1.5" stroke-opacity="0.35"/>
          <line x1="12" y1="5" x2="19" y2="12" stroke="#000" stroke-width="1.5" stroke-opacity="0.35"/>
          <line x1="19" y1="12" x2="12" y2="19" stroke="#000" stroke-width="1.5" stroke-opacity="0.35"/>
          <line x1="12" y1="19" x2="5" y2="12" stroke="#000" stroke-width="1.5" stroke-opacity="0.35"/>
          <circle cx="5" cy="12" r="2" fill="#000"/>
          <circle cx="19" cy="12" r="2" fill="#000"/>
          <circle cx="12" cy="5" r="2" fill="#000"/>
          <circle cx="12" cy="19" r="2" fill="#000"/>
          <circle cx="12" cy="12" r="3" fill="#000"/>
        </svg>
      </div>
      <div>
        <span class="auth-logo-name">NEXUS</span>
        <div class="auth-byline">by <a href="https://www.linkedin.com/in/aarushsrivatsa/" target="_blank" rel="noopener" class="auth-byline-link">Aarush Srivatsa</a></div>
      </div>
    </div>
    <h1 class="auth-h" id="auth-heading">Welcome back</h1>
    <p class="auth-sub" id="auth-subtext">Sign in to continue</p>
    <div class="seg">
      <button class="seg-btn on" onclick="switchTab('login')">Sign in</button>
      <button class="seg-btn" onclick="switchTab('signup')">Sign up</button>
      <button class="seg-btn" onclick="switchTab('reset')">Reset</button>
    </div>

    <div id="tab-login">
      <div class="fg"><label>Email</label><input type="email" id="l-email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')handleLogin()"></div>
      <div class="fg"><label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')handleLogin()">
          <button type="button" class="pw-eye" onclick="togglePw('l-pass',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>
      <button class="btn-main" onclick="handleLogin()">Sign in ‚Üí</button>
      <div class="auth-err" id="l-err"></div>
    </div>

    <div id="tab-signup" style="display:none">
      <div id="s-step-email">
        <div class="fg"><label>Email</label><input type="email" id="s-email" placeholder="you@example.com"></div>
        <div class="fg"><label>Password</label>
          <div class="pw-wrap">
            <input type="password" id="s-pass" placeholder="Min 8 characters">
            <button type="button" class="pw-eye" onclick="togglePw('s-pass',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          </div>
        </div>
        <div class="fg"><label>Confirm Password</label>
          <div class="pw-wrap">
            <input type="password" id="s-pass2" placeholder="Repeat password">
            <button type="button" class="pw-eye" onclick="togglePw('s-pass2',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          </div>
        </div>
        <button class="btn-main" onclick="handleSignup()">Send OTP ‚Üí</button>
        <div class="auth-err" id="s-err"></div>
      </div>
      <div id="s-step-otp" style="display:none">
        <div class="email-pill">
          <span id="s-email-display"></span>
          <button onclick="goBackToEmail()">Wrong email?</button>
        </div>
        <div class="fg"><label>Verification code</label>
          <div class="otp-row">
            <input type="text" id="s-otp" placeholder="000000" maxlength="6" onkeydown="if(event.key==='Enter')handleSignup()">
            <button class="otp-resend" id="s-resend-btn" onclick="resendOTP()" disabled>Resend <span id="s-timer"></span></button>
          </div>
        </div>
        <button class="btn-main" onclick="handleSignup()">Verify ‚Üí</button>
        <div class="auth-err" id="s-err2"></div>
      </div>
    </div>

    <div id="tab-reset" style="display:none">
      <div class="fg"><label>Email</label><input type="email" id="r-email" placeholder="you@example.com"></div>
      <div class="fg" id="r-otp-group" style="display:none"><label>OTP</label><input type="text" id="r-otp" placeholder="000000" maxlength="6"></div>
      <div class="fg" id="r-pass-group" style="display:none"><label>New Password</label>
        <div class="pw-wrap">
          <input type="password" id="r-pass" placeholder="Min 8 characters">
          <button type="button" class="pw-eye" onclick="togglePw('r-pass',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>
      <div class="fg" id="r-pass2-group" style="display:none"><label>Confirm Password</label>
        <div class="pw-wrap">
          <input type="password" id="r-pass2" placeholder="Repeat password">
          <button type="button" class="pw-eye" onclick="togglePw('r-pass2',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>
      <button class="btn-main" id="r-btn" onclick="handleReset()">Send OTP ‚Üí</button>
      <div class="auth-err" id="r-err"></div>
    </div>
  </div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="sb-top">
    <div class="sb-brand">
      <div class="sb-mark">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <circle cx="5" cy="12" r="2" fill="#000"/>
          <circle cx="19" cy="12" r="2" fill="#000"/>
          <circle cx="12" cy="5" r="2" fill="#000"/>
          <circle cx="12" cy="19" r="2" fill="#000"/>
          <line x1="5" y1="12" x2="19" y2="12" stroke="#000" stroke-width="1.5" stroke-opacity="0.4"/>
          <line x1="12" y1="5" x2="12" y2="19" stroke="#000" stroke-width="1.5" stroke-opacity="0.4"/>
          <line x1="5" y1="12" x2="12" y2="5" stroke="#000" stroke-width="1.5" stroke-opacity="0.4"/>
          <line x1="12" y1="5" x2="19" y2="12" stroke="#000" stroke-width="1.5" stroke-opacity="0.4"/>
          <line x1="19" y1="12" x2="12" y2="19" stroke="#000" stroke-width="1.5" stroke-opacity="0.4"/>
          <line x1="12" y1="19" x2="5" y2="12" stroke="#000" stroke-width="1.5" stroke-opacity="0.4"/>
          <circle cx="12" cy="12" r="2.5" fill="#000"/>
        </svg>
      </div>
      <div class="sb-brand-text">
        <span class="sb-name">NEXUS</span>
        <span class="sb-byline">by
          <a href="https://www.linkedin.com/in/aarushsrivatsa/" target="_blank" rel="noopener" class="sb-byline-link">Aarush Srivatsa</a>
        </span>
      </div>
    </div>
  </div>
  <div class="sb-new-wrap">
    <button class="sb-new-btn" onclick="openNewChat()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New conversation
    </button>
  </div>
  <div class="sb-list" id="sb-list"></div>
  <div class="sb-foot">
    <button class="sb-logout" onclick="handleLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign out
    </button>
  </div>
</div>

<!-- MAIN -->
<div id="main">
  <div class="topbar">
    <div class="topbar-left">
      <button class="topbar-icon-btn" id="sb-toggle" onclick="toggleSidebar()" title="Menu">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <span class="topbar-title" id="topbar-title">Select a conversation</span>
    </div>
    <div class="topbar-right">
      <button class="topbar-icon-btn" onclick="openNewChat()" title="New chat">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
    </div>
  </div>
  <div id="messages">
    <div class="no-conv">
      <div class="no-conv-glyph">‚ú¶</div>
      <div class="no-conv-text">Start a conversation</div>
      <div class="empty-hint">Web search ¬∑ Document memory ¬∑ Vision</div>
    </div>
  </div>
  <div class="input-area">
    <div class="input-wrap">
      <!-- textarea + action buttons row -->
      <div class="input-row">
        <textarea id="msg-input" placeholder="Message Nexus‚Ä¶" rows="1" onkeydown="handleKey(event)" oninput="resize(this)"></textarea>
        <div class="input-btns">
          <button class="ib" onclick="openUpload()" title="Attach">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
          </button>
          <button class="send-ib" id="send-btn" onclick="sendMessage()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
      <!-- model chip bar -->
      <div class="model-bar" id="model-bar">
        <span class="model-bar-label">Model</span>
      </div>
    </div>
  </div>
</div>

<!-- NEW CHAT MODAL -->
<div class="modal-bg" id="new-chat-modal" onclick="handleModalBgClick(event,'new-chat-modal')">
  <div class="modal-box" style="max-width:360px">
    <div class="modal-title">New conversation</div>
    <div class="modal-sub">Give it a name to get started</div>
    <div class="fg" style="margin-bottom:0">
      <label>Title</label>
      <input type="text" id="new-title" placeholder="e.g. Research, Coding, Ideas‚Ä¶" maxlength="60" onkeydown="if(event.key==='Enter')confirmNewChat()">
    </div>
    <div class="modal-foot">
      <button class="btn-ghost" onclick="closeModal('new-chat-modal')">Cancel</button>
      <button class="btn-act" onclick="confirmNewChat()">Create ‚Üí</button>
    </div>
  </div>
</div>

<!-- UPLOAD MODAL -->
<div class="modal-bg" id="upload-modal" onclick="handleModalBgClick(event,'upload-modal')">
  <div class="modal-box">
    <div class="modal-title">Attach file</div>
    <div class="modal-sub">Upload a document or image to this conversation</div>
    <div class="up-tabs">
      <button class="up-tab on" onclick="switchUpTab('doc')">Document</button>
      <button class="up-tab" onclick="switchUpTab('img')">Image</button>
    </div>
    <div class="dropzone" id="dropzone"
      onclick="document.getElementById('file-input').click()"
      ondragover="event.preventDefault();this.classList.add('drag')"
      ondragleave="this.classList.remove('drag')"
      ondrop="onDrop(event)">
      <div class="dropzone-icon" id="dz-icon">üìÑ</div>
      <div class="dropzone-text"><strong>Click to browse</strong> or drag &amp; drop<br><span id="dz-types">PDF, DOCX, TXT</span></div>
    </div>
    <input type="file" id="file-input" accept=".pdf,.docx,.txt" onchange="onFileSelect(event)">
    <div id="file-name"></div>
    <div class="modal-foot">
      <button class="btn-ghost" onclick="closeModal('upload-modal')">Cancel</button>
      <button class="btn-act" onclick="doUpload()">Upload ‚Üí</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const API = '';
const FILE_PREFIX = "024b4faf-5861-4f6b-840c-8f9b4cb660b1_";
const DEFAULT_MODEL = "groq/compound-beta";

// Models to hide from the chat UI (audio/speech, not LLMs)
const HIDDEN_MODELS = new Set([
  'whisper-large-v3',
  'whisper-large-v3-turbo',
  'canopylabs/orpheus-v1-english'
]);

let token = localStorage.getItem('at') || null;
let rtoken = localStorage.getItem('rt') || null;
let convId = null;
let upType = 'doc';
let selFile = null;
let signupStep = 'send';
let resetStep = 'send';
let signupEmail = null;
let busy = false;
let otpTimer = null;
let convMap = {};
let selectedModel = localStorage.getItem('selectedModel') || DEFAULT_MODEL;
let availableModels = [];

// ‚îÄ‚îÄ MODEL SELECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadModels() {
  try {
    const r = await fetch(API + '/api/v1/models/get_models');
    if (!r.ok) throw new Error('non-ok');
    availableModels = await r.json();
  } catch(e) {
    // Fallback so bar is never empty
    availableModels = [{id: DEFAULT_MODEL, name: 'Compound'}];
  }
  const chatModels = availableModels.filter(m => !HIDDEN_MODELS.has(m.id));
  renderModelBar(chatModels);
}

function renderModelBar(models) {
  const bar = document.getElementById('model-bar');
  // Remove any existing chips (keep the label)
  bar.querySelectorAll('.model-chip').forEach(el => el.remove());

  // Validate selectedModel is in this list
  if (!models.find(m => m.id === selectedModel)) {
    selectedModel = models[0]?.id || DEFAULT_MODEL;
    localStorage.setItem('selectedModel', selectedModel);
  }

  models.forEach(m => {
    const btn = document.createElement('button');
    btn.className = 'model-chip' + (m.id === selectedModel ? ' active' : '');
    btn.dataset.id = m.id;
    btn.innerHTML = '<span class="model-chip-dot"></span>' + esc(m.name);
    btn.addEventListener('click', () => selectModel(m.id));
    bar.appendChild(btn);
  });
}

function selectModel(id) {
  selectedModel = id;
  localStorage.setItem('selectedModel', id);
  document.querySelectorAll('.model-chip').forEach(el => {
    el.classList.toggle('active', el.dataset.id === id);
  });
}

// ‚îÄ‚îÄ SIDEBAR MOBILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('sb-overlay');
  const open = sb.classList.toggle('open');
  ov.classList.toggle('open', open);
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sb-overlay').classList.remove('open');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

window.onload = async () => {
  await loadModels();
  if (token) { showApp(); await loadConvs(); }
};

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function handleModalBgClick(event, modalId) {
  if (event.target === document.getElementById(modalId)) closeModal(modalId);
}

function switchTab(t) {
  ['login','signup','reset'].forEach((x,i) => {
    document.getElementById('tab-'+x).style.display = x===t ? '' : 'none';
    document.querySelectorAll('.seg-btn')[i].classList.toggle('on', x===t);
  });
  const map = {
    login:  ['Welcome back','Sign in to continue'],
    signup: ['Create account','Get started for free'],
    reset:  ['Reset password','Enter your email']
  };
  document.getElementById('auth-heading').textContent = map[t][0];
  document.getElementById('auth-subtext').textContent = map[t][1];
  if (t === 'signup') {
    document.getElementById('s-step-email').style.display = '';
    document.getElementById('s-step-otp').style.display = 'none';
    ['s-email','s-pass','s-pass2','s-otp'].forEach(id => document.getElementById(id).value = '');
    clrErr('s-err'); clrErr('s-err2');
    signupStep = 'send'; clearInterval(otpTimer);
  }
  if (t === 'reset') {
    resetStep = 'send';
    ['r-otp-group','r-pass-group','r-pass2-group'].forEach(id => document.getElementById(id).style.display = 'none');
    document.getElementById('r-btn').textContent = 'Send OTP ‚Üí';
    clrErr('r-err');
  }
}

function startOtpTimer() {
  let secs = 300;
  const btn = document.getElementById('s-resend-btn');
  const el  = document.getElementById('s-timer');
  btn.disabled = true; clearInterval(otpTimer);
  otpTimer = setInterval(() => {
    secs--;
    const m = Math.floor(secs/60), s = secs%60;
    el.textContent = '(' + m + ':' + String(s).padStart(2,'0') + ')';
    if (secs <= 0) { clearInterval(otpTimer); btn.disabled = false; el.textContent = ''; }
  }, 1000);
}

function togglePw(id, btn) {
  const inp = document.getElementById(id);
  const show = inp.type === 'password';
  inp.type = show ? 'text' : 'password';
  btn.innerHTML = show
    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
    : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
}

function goBackToEmail() {
  document.getElementById('s-step-otp').style.display = 'none';
  document.getElementById('s-step-email').style.display = '';
  document.getElementById('s-otp').value = '';
  clrErr('s-err2'); signupStep = 'send'; clearInterval(otpTimer);
}

async function handleLogin() {
  clrErr('l-err');
  const email = v('l-email'), password = v('l-pass');
  if (!email || !password) { setErr('l-err','Please fill all fields'); return; }
  try {
    const d = await apiPost('/api/v1/authentication/login', {email, password});
    saveTokens(d.access_token, d.refresh_token);
    showApp(); await loadConvs();
  } catch(e) { setErr('l-err', e.message); }
}

async function handleSignup() {
  if (signupStep === 'send') {
    clrErr('s-err');
    const email = v('s-email'), password = v('s-pass'), pass2 = v('s-pass2');
    if (!email||!password||!pass2) { setErr('s-err','Please fill all fields'); return; }
    if (password !== pass2) { setErr('s-err','Passwords do not match'); return; }
    if (password.length < 8) { setErr('s-err','Minimum 8 characters'); return; }
    try {
      await apiPost('/api/v1/authentication/signup/send-otp', {email, password});
      signupEmail = email;
      document.getElementById('s-step-email').style.display = 'none';
      document.getElementById('s-step-otp').style.display = '';
      document.getElementById('s-email-display').textContent = email;
      signupStep = 'verify'; startOtpTimer(); toast('OTP sent to your email');
    } catch(e) { setErr('s-err', e.message); }
  } else {
    clrErr('s-err2');
    const otp = v('s-otp');
    if (!otp) { setErr('s-err2', 'Please enter the OTP'); return; }
    try {
      const d = await apiPost('/api/v1/authentication/signup/verify-otp/'+signupEmail, {otp});
      saveTokens(d.access_token, d.refresh_token); showApp(); await loadConvs();
    } catch(e) { setErr('s-err2', e.message); }
  }
}

async function resendOTP() {
  if (!signupEmail) { toast('No email on record, go back and try again'); return; }
  try {
    const password = document.getElementById('s-pass').value;
    await apiPost('/api/v1/authentication/signup/send-otp', {email: signupEmail, password});
    startOtpTimer(); toast('OTP resent');
  } catch(e) { toast('Failed to resend: ' + e.message); }
}

async function handleReset() {
  clrErr('r-err');
  const email = v('r-email');
  if (resetStep === 'send') {
    if (!email) { setErr('r-err','Please enter your email'); return; }
    try {
      await apiPost('/api/v1/authentication/reset-password/send-otp', {email});
      ['r-otp-group','r-pass-group','r-pass2-group'].forEach(id => document.getElementById(id).style.display = '');
      document.getElementById('r-btn').textContent = 'Reset Password ‚Üí';
      resetStep = 'verify'; toast('OTP sent');
    } catch(e) { setErr('r-err', e.message); }
  } else {
    const pass = v('r-pass'), pass2 = v('r-pass2');
    if (!v('r-otp')) { setErr('r-err', 'Please enter the OTP'); return; }
    if (pass !== pass2) { setErr('r-err','Passwords do not match'); return; }
    if (pass.length < 8) { setErr('r-err','Minimum 8 characters'); return; }
    try {
      const d = await apiPost('/api/v1/authentication/reset-password/'+email, {otp: v('r-otp'), new_password: pass});
      saveTokens(d.access_token, d.refresh_token); showApp(); await loadConvs();
    } catch(e) { setErr('r-err', e.message); }
  }
}

function saveTokens(at, rt) {
  token = at; rtoken = rt;
  localStorage.setItem('at', at); localStorage.setItem('rt', rt);
}

async function doRefresh() {
  try {
    const d = await apiPost('/api/v1/authentication/refresh', {refresh_token: rtoken});
    saveTokens(d.access_token, d.refresh_token); return true;
  } catch(e) { handleLogout(); return false; }
}

async function af(url, opts={}) {
  if (!opts.headers) opts.headers = {};
  opts.headers['Authorization'] = 'Bearer ' + token;
  let r = await fetch(API + url, opts);
  if (r.status === 401) {
    if (!await doRefresh()) return null;
    opts.headers['Authorization'] = 'Bearer ' + token;
    r = await fetch(API + url, opts);
  }
  return r;
}

function handleLogout() {
  token = null; rtoken = null;
  const savedModel = selectedModel; // preserve across logout
  localStorage.clear();
  localStorage.setItem('selectedModel', savedModel);
  convId = null; convMap = {};
  document.getElementById('auth-overlay').classList.remove('hidden');
  document.getElementById('sb-list').innerHTML = '';
  document.getElementById('topbar-title').textContent = 'Select a conversation';
  setMsgs('<div class="no-conv"><div class="no-conv-glyph">‚ú¶</div><div class="no-conv-text">Start a conversation</div><div class="empty-hint">Web search ¬∑ Document memory ¬∑ Vision</div></div>');
}

function showApp() {
  document.getElementById('auth-overlay').classList.add('hidden');
}

// ‚îÄ‚îÄ CONVERSATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadConvs() {
  const r = await af('/api/v1/conversations/');
  if (!r || !r.ok) return;
  const convs = await r.json();
  convMap = {};
  convs.forEach(c => { convMap[c.id] = c; });

  const list = document.getElementById('sb-list');
  if (!convs.length) {
    list.innerHTML = '<div class="sb-section">No conversations yet</div>';
    return;
  }

  const grouped = {};
  convs.forEach(c => {
    const diff = (Date.now() - new Date(c.created_at)) / 86400000;
    const key = diff < 1 ? 'Today' : diff < 7 ? 'This week' : diff < 30 ? 'This month' : 'Older';
    (grouped[key] = grouped[key] || []).push(c);
  });

  const order = ['Today','This week','This month','Older'];
  list.innerHTML = order.filter(k => grouped[k]).map(k =>
    '<div class="sb-section">'+k+'</div>' +
    grouped[k].map(c =>
      '<div class="sb-item'+(String(c.id)===String(convId)?' active':'')+'" data-id="'+c.id+'">' +
        '<span class="sb-item-title">'+esc(c.title)+'</span>' +
        '<button class="sb-del" data-del="'+c.id+'" onclick="event.stopPropagation();delConv(\''+c.id+'\')" title="Delete">' +
          '<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
        '</button>' +
      '</div>'
    ).join('')
  ).join('');

  list.querySelectorAll('.sb-item[data-id]').forEach(el => {
    el.addEventListener('click', () => selConvById(el.dataset.id));
  });
}

function openNewChat() {
  document.getElementById('new-title').value = '';
  openModal('new-chat-modal');
  setTimeout(() => document.getElementById('new-title').focus(), 100);
}

async function confirmNewChat() {
  const title = document.getElementById('new-title').value.trim();
  if (!title) { toast('Please enter a title'); return; }
  closeModal('new-chat-modal');
  const r = await af('/api/v1/conversations/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({title})
  });
  if (!r || !r.ok) { toast('Failed to create conversation'); return; }
  const c = await r.json();
  convMap[c.id] = c;
  await loadConvs();
  selConvById(String(c.id));
}

function selConvById(id) {
  const key = Object.keys(convMap).find(k => String(k) === String(id));
  if (!key) { toast('Conversation not found'); return; }
  const c = convMap[key];
  selConv(c.id, c.title);
}

async function selConv(id, title) {
  convId = id;
  document.getElementById('topbar-title').textContent = title;
  closeSidebar();
  await loadConvs();
  await loadMsgs(id);
}

async function delConv(id) {
  const r = await af('/api/v1/conversations/'+id, {method:'DELETE'});
  if (!r || !r.ok) { toast('Failed to delete'); return; }
  if (String(convId) === String(id)) {
    convId = null;
    document.getElementById('topbar-title').textContent = 'Select a conversation';
    setMsgs('<div class="no-conv"><div class="no-conv-glyph">‚ú¶</div><div class="no-conv-text">Start a conversation</div><div class="empty-hint">Web search ¬∑ Document memory ¬∑ Vision</div></div>');
  }
  await loadConvs();
  toast('Deleted');
}

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function loadMsgs(id) {
  const r = await af('/api/v1/conversations/'+id+'/messages/');
  if (!r || !r.ok) return;
  const msgs = await r.json();
  if (!msgs.length) {
    setMsgs('<div class="empty"><div class="empty-glyph">‚ú¶</div><div class="empty-title">Start the conversation</div><div class="empty-hint">Ask anything, upload a document, or share an image</div></div>');
    return;
  }
  document.getElementById('messages').innerHTML = msgs.map(renderMsg).join('');
  scrollBot();
}

function renderMsg(m) {
  if (m.role === 'system' && m.content.startsWith(FILE_PREFIX)) {
    const rest = m.content.slice(FILE_PREFIX.length);
    const colon = rest.indexOf(':');
    const type = rest.slice(0, colon), filename = rest.slice(colon+1);
    return '<div class="file-pill"><div class="file-pill-inner">'+(type==='img'?'üñºÔ∏è':'üìÑ')+' <span>'+esc(filename)+'</span></div></div>';
  }
  if (m.role === 'system') return '';
  return '<div class="msg-row '+m.role+'"><div class="msg-bubble">'+fmt(m.content)+'</div></div>';
}

function fmt(t) {
  // 1. extract code blocks first to protect them
  const blocks = [];
  t = t.replace(/```([\w]*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    blocks.push('<pre><code>'+ esc(code.trim()) +'</code></pre>');
    return '\x00B'+(blocks.length-1)+'\x00';
  });

  // 2. inline code
  t = t.replace(/`([^`]+)`/g, (_, c) => '<code>'+esc(c)+'</code>');

  // 3. split into lines and process block-level elements
  const lines = t.split('\n');
  const out = [];
  let i = 0;

  while (i < lines.length) {
    const line = lines[i];

    // headings
    if (/^### (.+)/.test(line)) { out.push('<div class="mh3">'+inlineFmt(line.slice(4))+'</div>'); i++; continue; }
    if (/^## (.+)/.test(line))  { out.push('<div class="mh2">'+inlineFmt(line.slice(3))+'</div>'); i++; continue; }
    if (/^# (.+)/.test(line))   { out.push('<div class="mh1">'+inlineFmt(line.slice(2))+'</div>'); i++; continue; }

    // horizontal rule
    if (/^---+$/.test(line.trim())) { out.push('<hr>'); i++; continue; }

    // blockquote
    if (/^> (.+)/.test(line)) { out.push('<blockquote>'+inlineFmt(line.slice(2))+'</blockquote>'); i++; continue; }

    // unordered list ‚Äî collect consecutive items
    if (/^[-*] (.+)/.test(line)) {
      const items = [];
      while (i < lines.length && /^[-*] (.+)/.test(lines[i])) {
        items.push('<li>'+inlineFmt(lines[i].replace(/^[-*] /,''))+'</li>');
        i++;
      }
      out.push('<ul>'+items.join('')+'</ul>');
      continue;
    }

    // ordered list ‚Äî collect consecutive items
    if (/^\d+\. (.+)/.test(line)) {
      const items = [];
      while (i < lines.length && /^\d+\. (.+)/.test(lines[i])) {
        items.push('<li>'+inlineFmt(lines[i].replace(/^\d+\. /,''))+'</li>');
        i++;
      }
      out.push('<ol>'+items.join('')+'</ol>');
      continue;
    }

    // blank line ‚Äî paragraph break, skip
    if (line.trim() === '') {
      // only add spacing if there's meaningful content before and after
      if (out.length > 0) out.push('__BLANK__');
      i++; continue;
    }

    // collect consecutive normal lines into a paragraph
    const paraLines = [];
    while (i < lines.length && lines[i].trim() !== '' && !/^(#{1,3} |[-*] |\d+\. |> |---+|\x00B)/.test(lines[i])) {
      paraLines.push(inlineFmt(lines[i]));
      i++;
    }
    if (paraLines.length) out.push('<p>'+paraLines.join(' ')+'</p>');
  }

  // collapse consecutive blanks, use them as paragraph spacing
  let html = out.join('').replace(/(__BLANK__)+/g, '');

  // 4. restore code blocks
  html = html.replace(/\x00B(\d+)\x00/g, (_, idx) => blocks[idx]);

  return html;
}

function inlineFmt(t) {
  t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');
  t = t.replace(/~~(.+?)~~/g, '<s>$1</s>');
  t = t.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener" style="color:var(--a);text-decoration:underline">$1</a>');
  return t;
}

function scrollBot() {
  const el = document.getElementById('messages');
  requestAnimationFrame(() => { el.scrollTop = el.scrollHeight; });
}

async function sendMessage() {
  if (!convId) { toast('Select a conversation first'); return; }
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  if (!text || busy) return;
  busy = true;
  document.getElementById('send-btn').disabled = true;
  inp.value = '';
  inp.style.height = 'auto';

  const msgs = document.getElementById('messages');
  msgs.querySelector('.empty')?.remove();
  msgs.querySelector('.no-conv')?.remove();
  msgs.insertAdjacentHTML('beforeend','<div class="msg-row user"><div class="msg-bubble">'+esc(text).replace(/\n/g,'<br>')+'</div></div>');
  msgs.insertAdjacentHTML('beforeend','<div class="msg-row assistant" id="typing-row"><div class="msg-bubble"><div class="typing"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div></div></div>');
  scrollBot();

  try {
    const r = await af('/api/v1/conversations/'+convId+'/messages/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: text, model: selectedModel})
    });
    if (!r || !r.ok) {
      let detail = 'Error sending message';
      try { const d = await r.json(); detail = d.detail || detail; } catch(_) {}
      throw new Error(detail);
    }
    const d = await r.json();
    document.getElementById('typing-row')?.remove();
    msgs.insertAdjacentHTML('beforeend', renderMsg(d));
    scrollBot();
  } catch(e) {
    document.getElementById('typing-row')?.remove();
    toast(e.message || 'Failed to send');
  }
  busy = false;
  document.getElementById('send-btn').disabled = false;
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function resize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 160) + 'px';
}

// ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openUpload() {
  if (!convId) { toast('Select a conversation first'); return; }
  selFile = null;
  upType = 'doc';
  document.getElementById('file-name').textContent = '';
  document.getElementById('file-input').value = '';
  document.querySelectorAll('.up-tab').forEach((b,i) => b.classList.toggle('on', i===0));
  document.getElementById('dz-icon').textContent = 'üìÑ';
  document.getElementById('dz-types').textContent = 'PDF, DOCX, TXT';
  document.getElementById('file-input').accept = '.pdf,.docx,.txt';
  openModal('upload-modal');
}

function switchUpTab(t) {
  upType = t;
  document.querySelectorAll('.up-tab').forEach((b,i) => b.classList.toggle('on', i===(t==='doc'?0:1)));
  document.getElementById('dz-icon').textContent = t==='img' ? 'üñºÔ∏è' : 'üìÑ';
  document.getElementById('dz-types').textContent = t==='img' ? 'PNG, JPG, JPEG, WEBP' : 'PDF, DOCX, TXT';
  document.getElementById('file-input').accept = t==='img' ? 'image/png,image/jpeg,image/webp' : '.pdf,.docx,.txt';
  selFile = null;
  document.getElementById('file-name').textContent = '';
  document.getElementById('file-input').value = '';
}

function onFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  selFile = file;
  document.getElementById('file-name').textContent = '‚úì ' + file.name;
}

function onDrop(e) {
  e.preventDefault();
  document.getElementById('dropzone').classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  selFile = file;
  document.getElementById('file-name').textContent = '‚úì ' + file.name;
}

async function doUpload() {
  if (!selFile) { toast('Select a file first'); return; }
  if (!convId) { toast('Select a conversation first'); closeModal('upload-modal'); return; }
  const ep = upType === 'img'
    ? '/api/v1/conversations/'+convId+'/messages/image'
    : '/api/v1/conversations/'+convId+'/messages/documents';
  const fd = new FormData();
  fd.append('file', selFile);
  const filename = selFile.name, type = upType;
  closeModal('upload-modal');
  selFile = null;

  const msgs = document.getElementById('messages');
  msgs.querySelector('.empty')?.remove();
  msgs.querySelector('.no-conv')?.remove();
  msgs.insertAdjacentHTML('beforeend','<div id="upload-pending" class="file-pill"><div class="file-pill-inner">'+(type==='img'?'üñºÔ∏è':'üìÑ')+' <span>'+esc(filename)+'</span></div></div>');
  msgs.insertAdjacentHTML('beforeend','<div class="msg-row assistant" id="upload-typing"><div class="msg-bubble"><div class="typing"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div></div></div>');
  scrollBot();

  try {
    const r = await af(ep, {method:'POST', body:fd});
    document.getElementById('upload-pending')?.remove();
    document.getElementById('upload-typing')?.remove();
    if (!r || !r.ok) {
      let detail = 'Upload failed';
      try { const d = await r.json(); detail = d.detail || detail; } catch(_) {}
      throw new Error(detail);
    }
    await loadMsgs(convId);
    toast(type === 'img' ? 'Image processed' : 'Document added');
  } catch(e) {
    document.getElementById('upload-pending')?.remove();
    document.getElementById('upload-typing')?.remove();
    toast(e.message || 'Upload failed');
  }
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function v(id) { return document.getElementById(id).value.trim(); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function setErr(id, msg) { const el = document.getElementById(id); if(el) el.textContent = msg; }
function clrErr(id) { const el = document.getElementById(id); if(el) el.textContent = ''; }
function setMsgs(html) { document.getElementById('messages').innerHTML = html; }
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2600);
}
async function apiPost(url, body) {
  const r = await fetch(API+url, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  });
  const d = await r.json();
  if (!r.ok) throw new Error(d.detail || 'Request failed');
  return d;
}
</script>
</body>
</html>